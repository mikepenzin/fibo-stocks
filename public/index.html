<!doctype html>
<html lang="en" data-bs-theme="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stocks 1D Analyzer (Node)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{padding-block:24px}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    canvas{border:1px solid var(--bs-border-color); border-radius:.5rem; width:100%; height:auto}
    .kv{display:grid; grid-template-columns: 1fr auto; gap:.25rem .75rem}
    .kv .k{color:var(--bs-secondary-color)}
    .fib-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:.5rem}
    /* Enforce uppercase visually in the ticker input */
    #ticker.ticker-input{ text-transform: uppercase; }
    /* Custom autocomplete dropdown styling */
    #suggestBox.list-group { border: 1px solid #b6b6b6; box-shadow: 0 2px 8px #0001; background: #fff; }
    #suggestBox .autocomplete-item {
      display: flex; flex-direction: column; align-items: flex-start; padding: 8px 12px; border-bottom: 1px solid #f0f0f0; background: #fff; cursor: pointer; transition: background 0.15s;
    }
    #suggestBox .autocomplete-item:last-child { border-bottom: none; }
    #suggestBox .autocomplete-item:hover, #suggestBox .autocomplete-item.active { background: #f3f6fa; }
    #suggestBox .ac-symbol { font-weight: bold; font-size: 1.15em; color: #1a237e; letter-spacing: 1px; }
    #suggestBox .ac-type { font-size: 0.85em; margin-left: 8px; background: #e3e6ee; color: #333; border-radius: 6px; padding: 2px 7px; font-weight: 500; }
    #suggestBox .ac-name { color: #444; font-size: 0.98em; margin-top: 2px; }
    #suggestBox .ac-exch { color: #888; font-size: 0.85em; margin-top: 1px; }
  </style>
</head>
<body>
<div class="container">
  <header class="mb-3">
    <h1 class="h4 mb-1">üìà Stocks Analyzer</h1>
    <div class="text-secondary small">Express API + Bootstrap ‚Ä¢ Data: Yahoo Finance ‚Ä¢ Timeframe: <span id="headerTimeframe">1D</span></div>
  </header>

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <form id="form" class="row g-2 align-items-center">
        <div class="col-auto"><label for="ticker" class="col-form-label">Ticker</label></div>
        <div class="col-auto position-relative">
          <input id="ticker" class="form-control ticker-input" placeholder="e.g. NVDA, AAPL" required autocomplete="off" list="tickerList">
          <!-- <div id="suggestBox" class="position-absolute bg-body border rounded shadow-sm w-100 mt-1 d-none" style="z-index:1000; max-height: 260px; overflow:auto;"></div> -->
          <datalist id="tickerList"></datalist>
        </div>
        <div class="col-auto form-check ms-2">
          <input class="form-check-input" type="checkbox" id="showChart" checked>
          <label class="form-check-label" for="showChart">Show chart</label>
        </div>
        <div class="col-auto">
          <select id="range" class="form-select form-select-sm" style="min-width:110px">
            <option value="1d" selected>1 Day</option>
            <option value="1h">1 Hour</option>
            <option value="15m">15 Minutes</option>
            <option value="5m">5 Minutes</option>
            <option value="1w">1 Week</option>
          </select>
        </div>
        <div class="col-auto"><button id="go" class="btn btn-primary" type="submit">Analyze</button></div>
        <div class="col-auto"><span id="spin" class="spinner-border spinner-border-sm text-primary d-none"></span></div>
      </form>
    </div>
  </div>

  <div id="alert" class="alert alert-danger d-none" role="alert"></div>

  <div class="row g-3 mb-3">
    <div class="col-12 mb-2 d-flex justify-content-end gap-2">
      <button id="backtestBtn" class="btn btn-outline-warning btn-sm">Backtest Fib</button>
      <button id="downloadImg" class="btn btn-outline-primary btn-sm">Download as Image</button>
      <button id="copyImg" class="btn btn-outline-secondary btn-sm">Copy Result to Clipboard</button>
    </div>
    <div class="col-lg-6">
      <div id="panel" class="card shadow-sm d-none h-100">
        <div class="card-body">
          <div class="d-flex flex-wrap align-items-center justify-content-between">
            <div class="h5 mb-0" id="title"></div>
            <span class="badge text-bg-secondary">1D</span>
          </div>
          <hr class="my-3">
          <div class="kv small">
            <div class="k">Trend</div><div class="v" id="trend"></div>
            <div class="k">RSI(14)</div><div class="v" id="rsi"></div>
            <div class="k">CCI(14)</div><div class="v" id="cci"></div>
            <div class="k">ATR(14)</div><div class="v" id="atr"></div>
            <div class="k">ATR %</div><div class="v" id="atrpct"></div>
            <div class="k">Vol Œî vs 20d</div><div class="v" id="vold"></div>
            <div class="k">Earnings</div><div class="v" id="earn"></div>
          </div>
          <hr>
          <div class="mb-1 fw-semibold">Trade plan</div>
          <div class="kv">
            <div class="k">Bias</div><div class="v" id="bias"></div>
            <div class="k">Entry</div><div class="v mono" id="entry"></div>
            <div class="k">Stop Loss</div><div class="v mono" id="sl"></div>
            <div class="k">TP1</div><div class="v mono" id="tp1"></div>
            <div class="k">TP2</div><div class="v mono" id="tp2"></div>
          </div>
          <hr>
          <div class="mb-1 fw-semibold">Fibonacci levels (auto swing)</div>
          <div class="fib-grid small mono" id="fibs"></div>
          <div id="btSection" class="mt-3 d-none">
            <div class="fw-semibold mb-1">Backtest (recent swings)</div>
            <div class="small" id="btStats"></div>
            <div class="table-responsive small mt-2">
              <table class="table table-sm table-bordered align-middle mb-0">
                <thead class="table-light"><tr><th>Date</th><th>Entry(50%)</th><th>Target(38.2%)</th><th>Stop(61.8%)</th><th>Outcome</th></tr></thead>
                <tbody id="btRows"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div id="chartCard" class="card shadow-sm d-none h-100">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between">
            <div class="fw-semibold">Chart (OHLC + Fib)</div>
            <button id="savePng" class="btn btn-outline-secondary btn-sm">Save PNG</button>
          </div>
          <canvas id="chart" width="980" height="420" class="mt-2"></canvas>
          <div class="small text-secondary mt-2">Lightweight canvas rendering (approximate for quick visual context).</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
    <div id="mainToast" class="toast align-items-center text-bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastMsg">Copied to clipboard!</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <footer class="mt-4 text-secondary small">
     Made with ‚ù§Ô∏è by <a href="https://github.com/mikepenzin/fibo-stocks">Mike Penzin</a>
  </footer>
</div>

<script>
const $ = s=>document.querySelector(s);
const show = (el, v)=>el.classList.toggle('d-none', !v);
const pct = (x,d=2)=>Number.isFinite(x)?((x>=0?'+':'')+x.toFixed(d)+'%'):'n/a';
const fmt = (x,d=2)=>Number.isFinite(x)?Number(x).toFixed(d):'n/a';
function clearBacktest(){
  const s=document.getElementById('btSection'); if(!s) return;
  s.classList.add('d-none');
  const st=document.getElementById('btStats'); if(st) st.textContent='';
  const rows=document.getElementById('btRows'); if(rows) rows.innerHTML='';
}

// Uppercase + autocomplete for ticker input via backend proxy
const tickerEl = $('#ticker');
const boxEl = $('#suggestBox');
const listEl = $('#tickerList');
function upperSanitize(v){ return v.toUpperCase().replace(/[^A-Z0-9\.\-]/g,''); }
function showBox(show){ if(!boxEl) return; boxEl.classList.toggle('d-none', !show); }
function renderSuggestions(items){
  // Populate native datalist too (fallback / native dropdown)
  if (listEl) {
    const opts = (items||[]).map(it => {
      const lbl = `${(it.name||'').replace(/</g,'&lt;')} ${it.exch?`(${it.exch})`:''}`.trim();
      return `<option value="${it.symbol}" label="${lbl}"></option>`;
    }).join('');
    listEl.innerHTML = opts;
  }
  if(!boxEl) return;
  if(!items?.length){ boxEl.innerHTML=''; showBox(false); return; }
  boxEl.innerHTML = items.map(it=>
    `<div class="autocomplete-item" data-sym="${it.symbol}">
      <div><span class="ac-symbol">${it.symbol}</span>${it.type ? `<span class="ac-type">${it.type}</span>` : ''}</div>
      <div class="ac-name">${(it.name||'').replace(/</g,'&lt;')}</div>
      <div class="ac-exch">${it.exch||''}</div>
    </div>`
  ).join('');
  boxEl.classList.add('list-group');
  showBox(true);
  boxEl.querySelectorAll('[data-sym]').forEach(btn=>{
    btn.addEventListener('click',()=>{ tickerEl.value = btn.dataset.sym; showBox(false); tickerEl.focus(); });
  });
}
let suggestTimer;
async function fetchSuggestions(q){
  try{
    const r = await fetch(`/api/suggest?q=${encodeURIComponent(q)}`, { cache:'no-store' });
    const j = await r.json();
    if(!j.ok) return renderSuggestions([]);
    renderSuggestions(j.results||[]);
  }catch(e){ renderSuggestions([]); }
}
if (tickerEl) {
  tickerEl.addEventListener('input',(e)=>{
    const pos = e.target.selectionStart;
    e.target.value = upperSanitize(e.target.value);
    try{ e.target.setSelectionRange(pos,pos); }catch{}
    clearTimeout(suggestTimer);
    const v = e.target.value.trim();
    if (!v){ showBox(false); return; }
    suggestTimer = setTimeout(()=>fetchSuggestions(v), 150);
  });
  tickerEl.addEventListener('blur',()=> setTimeout(()=>showBox(false), 150));
  tickerEl.addEventListener('focus',()=>{ if (tickerEl.value) fetchSuggestions(tickerEl.value); });
}

// Update header timeframe when dropdown changes
const rangeEl = document.getElementById('range');
if (rangeEl) {
  rangeEl.addEventListener('change', (e) => {
    const headerTimeframe = document.getElementById('headerTimeframe');
    if (headerTimeframe) {
      headerTimeframe.textContent = e.target.value.toUpperCase();
    }
    clearBacktest(); // invalidate previous backtest when timeframe changes
  });
}

let lastTicker = '';
async function analyze(ticker){
  clearBacktest(); // hide old backtest while loading new ticker
  $('#alert').classList.add('d-none');
  $('#spin').classList.remove('d-none');
  try{
    const range = document.getElementById('range').value;
    const r = await fetch(`/api/analyze/${encodeURIComponent(ticker)}?range=${encodeURIComponent(range)}`);
    const j = await r.json();
    if(!j.ok) throw new Error(j.error||'API error');

    const { metrics, plan, candles } = j;
    $('#panel').classList.remove('d-none');
    $('#title').textContent = `${j.ticker} ‚Ä¢ ${metrics.trend_emoji} ${metrics.trend}`;
    // Show selected range in badge
    document.querySelector('#panel .badge').textContent = range.toUpperCase();
    $('#trend').textContent = metrics.trend;
    $('#rsi').textContent = fmt(metrics.rsi);
    $('#cci').textContent = fmt(metrics.cci,1);
    $('#atr').textContent = fmt(metrics.atr);
    $('#atrpct').textContent = pct(metrics.atr_pct);
    $('#vold').textContent = pct(metrics.vol_delta,1);
    $('#earn').textContent = metrics.earnings_str;

    $('#bias').textContent = plan.bias + ' ' + plan.stars;
    $('#entry').textContent = fmt(plan.entry);
    $('#sl').textContent = fmt(plan.sl);
    $('#tp1').textContent = fmt(plan.tp1);
    $('#tp2').textContent = fmt(plan.tp2);

    const fibDiv = $('#fibs'); fibDiv.innerHTML='';
    Object.entries(plan.fib).forEach(([k,v])=>{
      const d=document.createElement('div'); d.textContent = `${k}: ${fmt(v)}`; fibDiv.appendChild(d);
    });

    const showChart = $('#showChart').checked;
    show($('#chartCard'), showChart);
    if(showChart){ drawChart($('#chart'), candles.slice(-140), plan.fib); }

  }catch(err){
    const a=$('#alert'); a.textContent = 'Error: ' + (err.message || err); a.classList.remove('d-none');
  }finally{
    $('#spin').classList.add('d-none');
  }
}

function drawChart(canvas, rows, fib){
  const ctx=canvas.getContext('2d');
  const W=canvas.width, H=canvas.height;
  ctx.clearRect(0,0,W,H);
  const padL=50, padR=10, padT=10, padB=32; // increase padB for date labels
  const xs=rows.length;
  const prices = rows.flatMap(r=>[r.h,r.l]);
  const minP=Math.min(...prices), maxP=Math.max(...prices);
  const x = i => padL + (i/(xs-1))*(W-padL-padR);
  const y = p => padT + (1-(p-minP)/(maxP-minP))*(H-padT-padB);

  // grid
  ctx.strokeStyle=getComputedStyle(document.body).getPropertyValue('--bs-border-color');
  ctx.lineWidth=1; ctx.setLineDash([3,3]); ctx.beginPath();
  for(let i=0;i<=4;i++){ const yy=padT + i*(H-padT-padB)/4; ctx.moveTo(padL,yy); ctx.lineTo(W-padR,yy); }
  ctx.stroke(); ctx.setLineDash([]);

  // candles
  for(let i=0;i<rows.length;i++){
    const r=rows[i]; const cx=x(i);
    const col = r.c>=r.o ? '#198754' : '#dc3545';
    ctx.strokeStyle=col; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(cx,y(r.l)); ctx.lineTo(cx,y(r.h)); ctx.stroke();
    ctx.lineWidth=4; ctx.beginPath(); ctx.moveTo(cx,y(r.o)); ctx.lineTo(cx,y(r.c)); ctx.stroke();
  }

  // fib lines
  ctx.lineWidth=1; ctx.setLineDash([4,3]); ctx.strokeStyle='#6c757d';
  Object.entries(fib).forEach(([label,level])=>{
    const yy=y(level);
    ctx.beginPath(); ctx.moveTo(padL,yy); ctx.lineTo(W-padR,yy); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle='#6c757d'; ctx.font='12px system-ui';
    ctx.fillText(label, padL+2, yy-2);
    ctx.setLineDash([4,3]);
  });

  // x-axis date labels
  ctx.font = '12px system-ui';
  ctx.fillStyle = '#444';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'top';
  const dateStep = Math.ceil(xs / 7); // 7 labels max
  
  // Get current range to determine date format
  const currentRange = document.getElementById('range')?.value || '1d';
  
  for(let i=0;i<xs;i+=dateStep){
    const r = rows[i];
    let dateStr = '';
    if(r.t){
      const ts = r.t > 1e12 ? r.t : r.t*1000;
      const d = new Date(ts);
      
      // Format based on timeframe
      if (currentRange === '5m' || currentRange === '15m') {
        dateStr = d.toTimeString().slice(0,5); // HH:MM
      } else if (currentRange === '1h') {
        dateStr = d.toTimeString().slice(0,5); // HH:MM
      } else if (currentRange === '1w') {
        dateStr = d.toISOString().slice(0,10); // YYYY-MM-DD
      } else {
        dateStr = d.toISOString().slice(5,10); // MM-DD
      }
    } else if(r.date){
      dateStr = r.date.length > 6 ? r.date.slice(5,10) : r.date;
    } else {
      dateStr = String(i);
    }
    ctx.fillText(dateStr, x(i), H-padB+4);
  }
  
  // Always show last date
  if(xs>0){
    const r = rows[xs-1];
    let dateStr = '';
    if(r.t){
      const ts = r.t > 1e12 ? r.t : r.t*1000;
      const d = new Date(ts);
      
      if (currentRange === '5m' || currentRange === '15m') {
        dateStr = d.toTimeString().slice(0,5);
      } else if (currentRange === '1h') {
        dateStr = d.toTimeString().slice(0,5);
      } else if (currentRange === '1w') {
        dateStr = d.toISOString().slice(0,10);
      } else {
        dateStr = d.toISOString().slice(5,10);
      }
    } else if(r.date){
      dateStr = r.date.length > 6 ? r.date.slice(5,10) : r.date;
    } else {
      dateStr = String(xs-1);
    }
    ctx.fillText(dateStr, x(xs-1), H-padB+4);
  }
}

document.querySelector('#form').addEventListener('submit', (e)=>{
  e.preventDefault();
  const t = document.querySelector('#ticker').value.trim();
  if(!t) return;
  showBox(false);
  analyze(t.toUpperCase());
});

document.querySelector('#savePng').addEventListener('click', ()=>{
  const c=document.querySelector('#chart');
  const a=document.createElement('a'); a.href=c.toDataURL('image/png'); a.download='chart.png'; a.click();
});

function copyChartToClone(cloneCard) {
  const origCanvas = document.getElementById('chart');
  const cloneCanvas = cloneCard.querySelector('canvas');
  if (origCanvas && cloneCanvas) {
    cloneCanvas.width = origCanvas.width;
    cloneCanvas.height = origCanvas.height;
    const ctx = cloneCanvas.getContext('2d');
    ctx.drawImage(origCanvas, 0, 0);
  }
}

document.getElementById('downloadImg').addEventListener('click', async () => {
  const container = document.createElement('div');
  container.style.display = 'flex';
  container.style.gap = '16px';
  container.style.background = '#fff';
  container.style.padding = '16px';
  const panelClone = document.getElementById('panel').cloneNode(true);
  const chartCardClone = document.getElementById('chartCard').cloneNode(true);
  copyChartToClone(chartCardClone);
  container.appendChild(panelClone);
  container.appendChild(chartCardClone);
  document.body.appendChild(container);
  html2canvas(container, {backgroundColor: '#fff'}).then(canvas => {
    const a = document.createElement('a');
    a.href = canvas.toDataURL('image/png');
    a.download = 'stock-analysis.png';
    a.click();
    document.body.removeChild(container);
  });
});

function showToast(msg, type = 'primary') {
  const toastEl = document.getElementById('mainToast');
  const toastMsg = document.getElementById('toastMsg');
  toastMsg.textContent = msg;
  toastEl.className = `toast align-items-center text-bg-${type} border-0`;
  const toast = new bootstrap.Toast(toastEl, { delay: 2500 });
  toast.show();
}

document.getElementById('copyImg').addEventListener('click', async () => {
  const container = document.createElement('div');
  container.style.display = 'flex';
  container.style.gap = '16px';
  container.style.background = '#fff';
  container.style.padding = '16px';
  const panelClone = document.getElementById('panel').cloneNode(true);
  const chartCardClone = document.getElementById('chartCard').cloneNode(true);
  copyChartToClone(chartCardClone);
  container.appendChild(panelClone);
  container.appendChild(chartCardClone);
  document.body.appendChild(container);
  html2canvas(container, {backgroundColor: '#fff'}).then(async canvas => {
    canvas.toBlob(async blob => {
      try {
        await navigator.clipboard.write([
          new ClipboardItem({ 'image/png': blob })
        ]);
        showToast('Copied to clipboard!', 'success');
      } catch (e) {
        showToast('Copy failed: ' + e, 'danger');
      }
      document.body.removeChild(container);
    });
  });
});

// Backtest logic
const backtestBtn = document.getElementById('backtestBtn');
if (backtestBtn){
  backtestBtn.addEventListener('click', async ()=>{
    const t = tickerEl.value.trim();
    if(!t){ showToast('Enter ticker first','danger'); return; }
    backtestBtn.disabled = true; backtestBtn.textContent = 'Testing...';
    try {
      const range = document.getElementById('range').value;
      const r = await fetch(`/api/backtest/${encodeURIComponent(t)}?range=${encodeURIComponent(range)}`);
      const j = await r.json();
      if(!j.ok) throw new Error(j.error||'Backtest failed');
      const s = j.stats;
      const statsLine = `Setups: ${s.setups} ‚Ä¢ Wins: ${s.wins} ‚Ä¢ Losses: ${s.losses} ‚Ä¢ No Exit: ${s.noExit} ‚Ä¢ WinRate: ${s.winRate}%`;
      document.getElementById('btStats').textContent = statsLine;
      const rowsHtml = (j.samples||[]).map(r=>`<tr><td>${r.date||''}</td><td>${fmt(r.entry)}</td><td>${fmt(r.target)}</td><td>${fmt(r.stop)}</td><td class="${r.outcome==='WIN'?'text-success':r.outcome==='LOSS'?'text-danger':'text-muted'}">${r.outcome}</td></tr>`).join('');
      document.getElementById('btRows').innerHTML = rowsHtml || '<tr><td colspan="5" class="text-center text-muted">No samples</td></tr>';
      document.getElementById('btSection').classList.remove('d-none');
      showToast('Backtest done','success');
    } catch(e){
      showToast(e.message,'danger');
    } finally {
      backtestBtn.disabled = false; backtestBtn.textContent = 'Backtest Fib';
    }
  });
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</body>
</html>
